---
# ── 1. Packages ──────────────────────────────────────────────
- name: Install nginx and openssl
  ansible.builtin.apt:
    name:
      - nginx
      - openssl
    state: present
    update_cache: true
  become: true

# ── 2. CA-signed SSL certificate (with SAN) ───────────────────
- name: Create SSL directory
  ansible.builtin.file:
    path: /etc/nginx/ssl
    state: directory
    owner: root
    group: root
    mode: "0700"
  become: true

- name: Check if certificate is already CA-signed
  ansible.builtin.shell:
    cmd: >
      openssl x509 -in /etc/nginx/ssl/wordpress-front.crt
      -issuer -noout 2>/dev/null | grep -q "Infra Local CA"
  register: cert_ca_signed
  failed_when: false
  changed_when: false
  become: true

- name: Copy CA certificate from control node
  ansible.builtin.copy:
    src: "{{ infra_ca_dir }}/ca.crt"
    dest: /etc/nginx/ssl/ca.crt
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Copy CA key temporarily for signing
  ansible.builtin.copy:
    src: "{{ infra_ca_dir }}/ca.key"
    dest: /tmp/infra-ca.key
    owner: root
    group: root
    mode: "0600"
  when: cert_ca_signed.rc != 0
  become: true

- name: Generate server private key
  ansible.builtin.command:
    cmd: openssl genrsa -out /etc/nginx/ssl/wordpress-front.key 4096
  when: cert_ca_signed.rc != 0
  changed_when: true
  become: true

- name: Deploy OpenSSL SAN configuration
  ansible.builtin.template:
    src: openssl-san.cnf.j2
    dest: /tmp/openssl-san.cnf
    mode: "0644"
  when: cert_ca_signed.rc != 0
  become: true

- name: Generate certificate signing request
  ansible.builtin.command:
    cmd: >
      openssl req -new
      -key /etc/nginx/ssl/wordpress-front.key
      -out /tmp/wordpress-front.csr
      -config /tmp/openssl-san.cnf
  when: cert_ca_signed.rc != 0
  changed_when: true
  become: true

- name: Sign certificate with infrastructure CA
  ansible.builtin.command:
    cmd: >
      openssl x509 -req
      -in /tmp/wordpress-front.csr
      -CA /etc/nginx/ssl/ca.crt
      -CAkey /tmp/infra-ca.key
      -CAcreateserial
      -out /etc/nginx/ssl/wordpress-front.crt
      -days 3650 -sha256
      -extensions v3_req
      -extfile /tmp/openssl-san.cnf
  when: cert_ca_signed.rc != 0
  changed_when: true
  become: true
  notify: restart nginx

- name: Remove temporary signing files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/infra-ca.key
    - /tmp/wordpress-front.csr
    - /tmp/openssl-san.cnf
    - /etc/nginx/ssl/ca.srl
  become: true

- name: Set SSL key permissions
  ansible.builtin.file:
    path: /etc/nginx/ssl/wordpress-front.key
    owner: root
    group: root
    mode: "0600"
  become: true

# ── 3. Nginx frontend configuration ─────────────────────────
- name: Deploy nginx frontend site config
  ansible.builtin.template:
    src: nginx-frontend.conf.j2
    dest: /etc/nginx/sites-available/wordpress-frontend
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart nginx

- name: Enable WordPress frontend nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/wordpress-frontend
    dest: /etc/nginx/sites-enabled/wordpress-frontend
    state: link
  become: true
  notify: restart nginx

- name: Remove nginx default site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: true
  notify: restart nginx

- name: Start and enable nginx
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true
  become: true

- name: Flush handlers (restart nginx with new config)
  ansible.builtin.meta: flush_handlers

# ── 4. UFW firewall ──────────────────────────────────────────
- name: Check UFW status
  ansible.builtin.command:
    cmd: ufw status
  register: ufw_status
  changed_when: false
  become: true

- name: Configure UFW firewall rules
  ansible.builtin.shell: |
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 80/tcp
    ufw allow 4433/tcp
    ufw allow 22/tcp
    ufw delete allow 443/tcp 2>/dev/null || true
    ufw --force enable
  when: "'4433' not in ufw_status.stdout"
  changed_when: true
  become: true

- name: Show UFW status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_final
  changed_when: false
  become: true

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_final.stdout_lines
