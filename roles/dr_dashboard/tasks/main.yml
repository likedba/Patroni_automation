---
# ── HA Dashboard WordPress plugin deployment ───────────────────
# Deploys the plugin to all backends, activates once (shared DB)

# ── 1. Copy plugin files ──────────────────────────────────────
- name: Create dr-dashboard plugin directory
  ansible.builtin.file:
    path: /var/www/html/wp-content/plugins/dr-dashboard
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  become: true

- name: Deploy dr-dashboard.php plugin file
  ansible.builtin.copy:
    src: dr-dashboard.php
    dest: /var/www/html/wp-content/plugins/dr-dashboard/dr-dashboard.php
    owner: www-data
    group: www-data
    mode: "0644"
  become: true

# ── 2. Activate plugin (once — shared Patroni DB) ─────────────
- name: Check if HA Dashboard plugin is active
  ansible.builtin.command:
    cmd: wp plugin is-active dr-dashboard --allow-root --path=/var/www/html
  register: drd_active
  failed_when: false
  changed_when: false
  run_once: true
  become: true

- name: Activate HA Dashboard plugin
  ansible.builtin.command:
    cmd: wp plugin activate dr-dashboard --allow-root --path=/var/www/html
  when: drd_active.rc != 0
  run_once: true
  changed_when: true
  become: true

# ── 3. Clean up duplicate pages and Sample Page ───────────────
#   Also renames old "DR Dashboard" pages to "HA Dashboard"
- name: Clean up duplicate pages, rename DR to HA, remove Sample Page
  ansible.builtin.shell: |
    wp eval --allow-root --path=/var/www/html '
    $pages = get_posts(array(
      "post_type"    => "page",
      "post_status"  => "any",
      "numberposts"  => -1,
      "orderby"      => "ID",
      "order"        => "ASC"
    ));
    $keep = array();
    $deleted = 0;
    foreach ($pages as $p) {
      $t = trim($p->post_title);
      if ($t === "Sample Page") {
        wp_delete_post($p->ID, true);
        $deleted++;
      } elseif ($t === "DR Dashboard" || $t === "HA Dashboard") {
        if (!isset($keep["HA Dashboard"])) {
          wp_update_post(array("ID" => $p->ID, "post_title" => "HA Dashboard"));
          $keep["HA Dashboard"] = $p->ID;
        } else {
          wp_delete_post($p->ID, true);
          $deleted++;
        }
      } elseif ($t === "Patroni Automation") {
        if (!isset($keep[$t])) {
          $keep[$t] = $p->ID;
        } else {
          wp_delete_post($p->ID, true);
          $deleted++;
        }
      }
    }
    echo $deleted > 0 ? "cleaned:$deleted" : "ok";
    '
  register: page_cleanup
  run_once: true
  changed_when: "'cleaned' in page_cleanup.stdout"
  become: true

# ── 4. Create dashboard page if missing ────────────────────────
- name: Check if HA Dashboard page exists via PHP
  ansible.builtin.shell: |
    wp eval --allow-root --path=/var/www/html '
    $pages = get_posts(array(
      "post_type"   => "page",
      "post_status" => "publish",
      "numberposts" => 1,
      "orderby"     => "ID",
      "order"       => "ASC",
      "title"       => "HA Dashboard"
    ));
    echo !empty($pages) ? $pages[0]->ID : "";
    '
  register: drd_page_check
  run_once: true
  failed_when: false
  changed_when: false
  become: true

- name: Create HA Dashboard page
  ansible.builtin.command:
    cmd: >
      wp post create
      --allow-root --path=/var/www/html
      --post_type=page --post_status=publish
      --post_title="HA Dashboard"
      --post_content="[dr_dashboard]"
      --porcelain
  register: drd_page_created
  when: drd_page_check.stdout | trim | length == 0
  run_once: true
  changed_when: true
  become: true

- name: Show HA Dashboard page URL
  ansible.builtin.debug:
    msg: "HA Dashboard available at: {{ wp_site_url }}/?page_id={{ drd_page_created.stdout | default(drd_page_check.stdout) | trim }}"
  run_once: true
  when: (drd_page_created.stdout | default(drd_page_check.stdout) | default('')) | trim | length > 0
