---
# ── HA Dashboard WordPress plugin deployment ───────────────────
# Deploys the plugin to all backends, activates once (shared DB)

# ── 1. Copy plugin files ──────────────────────────────────────
- name: Create dr-dashboard plugin directory
  ansible.builtin.file:
    path: /var/www/html/wp-content/plugins/dr-dashboard
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  become: true

- name: Deploy dr-dashboard.php plugin file
  ansible.builtin.copy:
    src: dr-dashboard.php
    dest: /var/www/html/wp-content/plugins/dr-dashboard/dr-dashboard.php
    owner: www-data
    group: www-data
    mode: "0644"
  become: true

# ── 2. Activate plugin (once — shared Patroni DB) ─────────────
- name: Check if HA Dashboard plugin is active
  ansible.builtin.command:
    cmd: wp plugin is-active dr-dashboard --allow-root --path=/var/www/html
  register: drd_active
  failed_when: false
  changed_when: false
  run_once: true
  become: true

- name: Activate HA Dashboard plugin
  ansible.builtin.command:
    cmd: wp plugin activate dr-dashboard --allow-root --path=/var/www/html
  when: drd_active.rc != 0
  run_once: true
  changed_when: true
  become: true

# ── 3. Clean up: keep one HA Dashboard, delete everything else ──
- name: Clean up pages — keep one HA Dashboard as homepage, delete rest
  ansible.builtin.shell: |
    wp eval --allow-root --path=/var/www/html '
    $pages = get_posts(array(
      "post_type"    => "page",
      "post_status"  => "any",
      "numberposts"  => -1,
      "orderby"      => "ID",
      "order"        => "ASC"
    ));
    $ha_id = 0;
    $deleted = 0;
    foreach ($pages as $p) {
      $t = trim($p->post_title);
      if (($t === "DR Dashboard" || $t === "HA Dashboard") && $ha_id === 0) {
        wp_update_post(array("ID" => $p->ID, "post_title" => "HA Dashboard", "post_content" => "[dr_dashboard]"));
        $ha_id = $p->ID;
      } elseif ($t === "DR Dashboard" || $t === "HA Dashboard" || $t === "Sample Page" || $t === "Patroni Automation") {
        wp_delete_post($p->ID, true);
        $deleted++;
      }
    }
    if ($ha_id > 0) {
      update_option("show_on_front", "page");
      update_option("page_on_front", $ha_id);
    }
    echo $deleted > 0 ? "cleaned:$deleted,home=$ha_id" : "ok,home=$ha_id";
    '
  register: page_cleanup
  run_once: true
  changed_when: "'cleaned' in page_cleanup.stdout"
  become: true

# ── 4. Create HA Dashboard page if none existed ────────────────
- name: Check if HA Dashboard page exists via PHP
  ansible.builtin.shell: |
    wp eval --allow-root --path=/var/www/html '
    $pages = get_posts(array(
      "post_type"   => "page",
      "post_status" => "publish",
      "numberposts" => 1,
      "orderby"     => "ID",
      "order"       => "ASC",
      "title"       => "HA Dashboard"
    ));
    echo !empty($pages) ? $pages[0]->ID : "";
    '
  register: drd_page_check
  run_once: true
  failed_when: false
  changed_when: false
  become: true

- name: Create HA Dashboard page
  ansible.builtin.command:
    cmd: >
      wp post create
      --allow-root --path=/var/www/html
      --post_type=page --post_status=publish
      --post_title="HA Dashboard"
      --post_content="[dr_dashboard]"
      --porcelain
  register: drd_page_created
  when: drd_page_check.stdout | trim | length == 0
  run_once: true
  changed_when: true
  become: true

- name: Set HA Dashboard as homepage
  ansible.builtin.shell: |
    wp option update show_on_front 'page' --allow-root --path=/var/www/html
    wp option update page_on_front '{{ drd_page_created.stdout | default(drd_page_check.stdout) | trim }}' --allow-root --path=/var/www/html
  when: (drd_page_created.stdout | default(drd_page_check.stdout) | default('')) | trim | length > 0
  run_once: true
  changed_when: true
  become: true

- name: Show HA Dashboard URL
  ansible.builtin.debug:
    msg: "HA Dashboard set as homepage: {{ wp_site_url }}/"
  run_once: true
