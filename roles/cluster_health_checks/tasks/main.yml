---
- name: Start etcd service on all nodes
  service:
    name: etcd
    state: started

- name: Wait for etcd port
  wait_for:
    port: 2379
    host: "{{ ansible_host | default(inventory_hostname) }}"
    timeout: 120
  delegate_to: localhost

- name: Check etcd cluster status table from node1
  command: etcdctl endpoint status --cluster -w table
  become_user: postgres
  register: etcd_status
  changed_when: false
  run_once: true
  delegate_to: "{{ patroni1_hostname }}.{{ domain }}"

- name: Print etcd cluster status
  debug:
    msg: "{{ etcd_status.stdout_lines }}"
  run_once: true

- name: Validate etcd cluster has 3 endpoints
  assert:
    that:
      - "(etcd_status.stdout | regex_findall('\\|\\s+192\\.168\\.1\\.(135|136|137):2379\\s+\\|') | length) == 3"
    fail_msg: "ETCD cluster validation failed, expected 3 healthy endpoints."
  run_once: true

- name: Start patroni service on all nodes
  service:
    name: patroni
    state: started

- name: Wait for patroni REST API
  wait_for:
    port: 8008
    host: "{{ ansible_host | default(inventory_hostname) }}"
    timeout: 180
  delegate_to: localhost

- name: Check patroni cluster state from node1
  command: patronictl -c /etc/patroni.yml list
  become_user: postgres
  register: patroni_status
  changed_when: false
  run_once: true
  delegate_to: "{{ patroni1_hostname }}.{{ domain }}"

- name: Print patroni cluster status
  debug:
    msg: "{{ patroni_status.stdout_lines }}"
  run_once: true

- name: Validate patroni states are running/streaming
  assert:
    that:
      - "(patroni_status.stdout | regex_findall('\\|\\s+[^|]+\\|\\s+192\\.168\\.1\\.(135|136|137)\\s+\\|\\s+[^|]+\\|\\s+(running|streaming)\\s+\\|') | length) == 3"
    fail_msg: "Patroni cluster validation failed: all three members must be running/streaming."
  run_once: true
