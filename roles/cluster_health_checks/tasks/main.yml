---
- name: Start etcd service on all nodes
  service:
    name: etcd
    state: started

- name: Wait for etcd port
  wait_for:
    port: 2379
    host: "{{ ansible_host | default(inventory_hostname) }}"
    timeout: 120
  delegate_to: localhost

- name: Check etcd cluster status table from node1
  command: etcdctl endpoint status --cluster -w table
  become_user: postgres
  register: etcd_status
  changed_when: false
  run_once: true
  delegate_to: "{{ patroni1_hostname }}.{{ domain }}"

- name: Print etcd cluster status
  debug:
    msg: "{{ etcd_status.stdout_lines }}"
  run_once: true

- name: Validate etcd cluster has 3 endpoints
  assert:
    that:
      - "patroni1_ip ~ ':2379' in etcd_status.stdout"
      - "patroni2_ip ~ ':2379' in etcd_status.stdout"
      - "patroni3_ip ~ ':2379' in etcd_status.stdout"
    fail_msg: >-
      ETCD cluster validation failed, expected 3 healthy endpoints
      ({{ patroni1_ip }}, {{ patroni2_ip }}, {{ patroni3_ip }}).
  run_once: true

- name: Start patroni service on all nodes
  service:
    name: patroni
    state: started

- name: Wait for patroni REST API
  wait_for:
    port: 8008
    host: "{{ ansible_host | default(inventory_hostname) }}"
    timeout: 180
  delegate_to: localhost

- name: Check patroni cluster state from node1
  command: patronictl -c /etc/patroni.yml list
  become_user: postgres
  register: patroni_status
  changed_when: false
  run_once: true
  delegate_to: "{{ patroni1_hostname }}.{{ domain }}"

- name: Print patroni cluster status
  debug:
    msg: "{{ patroni_status.stdout_lines }}"
  run_once: true

- name: Validate patroni states are running/streaming
  assert:
    that:
      - "patroni_status.stdout | regex_search(patroni1_ip ~ '\\s+\\|\\s+\\S+\\s+\\|\\s+(running|streaming)')"
      - "patroni_status.stdout | regex_search(patroni2_ip ~ '\\s+\\|\\s+\\S+\\s+\\|\\s+(running|streaming)')"
      - "patroni_status.stdout | regex_search(patroni3_ip ~ '\\s+\\|\\s+\\S+\\s+\\|\\s+(running|streaming)')"
    fail_msg: >-
      Patroni cluster validation failed: all three members must be running/streaming
      ({{ patroni1_ip }}, {{ patroni2_ip }}, {{ patroni3_ip }}).
  run_once: true
