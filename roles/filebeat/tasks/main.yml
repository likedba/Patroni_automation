---
# ── 0. Clean up broken Elastic apt repo (if exists) ───────────
- name: Remove broken Elastic apt repository
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/elastic-8.x.list
    state: absent
  become: true

- name: Remove Elastic GPG key
  ansible.builtin.file:
    path: /etc/apt/keyrings/elasticsearch.asc
    state: absent
  become: true

# ── 1. Create Filebeat directory ──────────────────────────────
- name: Create Filebeat directory
  ansible.builtin.file:
    path: /opt/filebeat
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

# ── 2. Deploy Filebeat configuration ─────────────────────────
- name: Deploy filebeat.yml
  ansible.builtin.template:
    src: filebeat.yml.j2
    dest: /opt/filebeat/filebeat.yml
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart filebeat

# ── 3. Deploy docker-compose.yml ─────────────────────────────
- name: Deploy Filebeat docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/filebeat/docker-compose.yml
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart filebeat

# ── 4. Start Filebeat container ───────────────────────────────
- name: Check if Filebeat container is running
  ansible.builtin.command:
    cmd: docker compose -f /opt/filebeat/docker-compose.yml ps -q
  register: fb_container
  changed_when: false
  failed_when: false
  become: true

- name: Start Filebeat container
  ansible.builtin.command:
    cmd: docker compose -f /opt/filebeat/docker-compose.yml up -d
  become: true
  when: fb_container.stdout == ""
  changed_when: true

- name: Flush handlers (apply config changes)
  ansible.builtin.meta: flush_handlers

# ── 5. Verification ──────────────────────────────────────────
- name: Wait for Filebeat container to start
  ansible.builtin.command:
    cmd: docker inspect --format '{{ '{{' }}.State.Running{{ '}}' }}' filebeat
  register: fb_running
  retries: 5
  delay: 5
  until: fb_running.stdout == "true"
  changed_when: false
  become: true

- name: Display Filebeat container status
  ansible.builtin.debug:
    msg: "{{ inventory_hostname }}: Filebeat container running = {{ fb_running.stdout }}"
