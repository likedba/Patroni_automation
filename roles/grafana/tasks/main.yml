---
# ── 1. Install Grafana ───────────────────────────────────────
- name: Check if Grafana is already installed
  ansible.builtin.command:
    cmd: dpkg -l grafana
  register: grafana_installed
  failed_when: false
  changed_when: false
  become: false

- name: Download Grafana OSS deb package (force IPv4)
  ansible.builtin.shell:
    cmd: curl -4 -fsSL -o /tmp/grafana.deb https://dl.grafana.com/oss/release/grafana_11.5.1_amd64.deb
  when: grafana_installed.rc != 0
  become: false
  changed_when: true
  register: dl_grafana
  retries: 3
  delay: 10
  until: dl_grafana.rc == 0

- name: Install Grafana OSS
  ansible.builtin.apt:
    deb: /tmp/grafana.deb
    state: present
  when: grafana_installed.rc != 0
  become: true

# ── 3. Self-signed SSL certificate ───────────────────────────
- name: Check if Grafana SSL certificate already exists
  ansible.builtin.stat:
    path: /etc/grafana/grafana.crt
  register: grafana_ssl_cert

- name: Generate self-signed SSL certificate for Grafana
  ansible.builtin.command:
    cmd: >
      openssl req -x509 -nodes -newkey rsa:4096 -days 3650
      -keyout /etc/grafana/grafana.key
      -out /etc/grafana/grafana.crt
      -subj "/C=FI/L=Helsinki/O=infra/OU=monitoring/CN={{ inventory_hostname }}.{{ domain }}"
  when: not grafana_ssl_cert.stat.exists
  changed_when: true
  become: true

- name: Set Grafana SSL key permissions
  ansible.builtin.file:
    path: /etc/grafana/grafana.key
    owner: grafana
    group: grafana
    mode: "0600"
  become: true

- name: Set Grafana SSL cert permissions
  ansible.builtin.file:
    path: /etc/grafana/grafana.crt
    owner: grafana
    group: grafana
    mode: "0644"
  become: true

# ── 4. Deploy grafana.ini ────────────────────────────────────
- name: Deploy grafana.ini
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
    owner: root
    group: grafana
    mode: "0640"
  become: true
  notify: restart grafana-server

# ── 5. Install Zabbix plugin ─────────────────────────────────
- name: Check if Zabbix plugin is already installed
  ansible.builtin.stat:
    path: /var/lib/grafana/plugins/alexanderzobnin-zabbix-app
  register: zabbix_plugin

- name: Download Grafana Zabbix plugin (force IPv4)
  ansible.builtin.shell:
    cmd: >-
      curl -4 -fsSL -L
      https://grafana.com/api/plugins/alexanderzobnin-zabbix-app/versions/latest/download
      -o /tmp/alexanderzobnin-zabbix-app.zip
  when: not zabbix_plugin.stat.exists
  changed_when: true
  become: true

- name: Ensure Grafana plugins directory exists
  ansible.builtin.file:
    path: /var/lib/grafana/plugins
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"
  become: true

- name: Extract Grafana Zabbix plugin to plugins directory
  ansible.builtin.unarchive:
    src: /tmp/alexanderzobnin-zabbix-app.zip
    dest: /var/lib/grafana/plugins/
    remote_src: true
    owner: grafana
    group: grafana
  when: not zabbix_plugin.stat.exists
  become: true
  notify: restart grafana-server

# ── 6. Datasource provisioning ───────────────────────────────
- name: Deploy Zabbix datasource provisioning
  ansible.builtin.template:
    src: zabbix-datasource.yml.j2
    dest: /etc/grafana/provisioning/datasources/zabbix.yml
    owner: root
    group: grafana
    mode: "0640"
  become: true
  notify: restart grafana-server

# ── 7. Dashboard provisioning ───────────────────────────────
- name: Ensure dashboards directory exists
  ansible.builtin.file:
    path: /var/lib/grafana/dashboards
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"
  become: true

- name: Deploy dashboard provisioning config
  ansible.builtin.template:
    src: dashboards-provisioning.yml.j2
    dest: /etc/grafana/provisioning/dashboards/default.yml
    owner: root
    group: grafana
    mode: "0640"
  become: true
  notify: restart grafana-server

- name: Deploy dashboard JSON files
  ansible.builtin.copy:
    src: "dashboards/{{ item }}"
    dest: "/var/lib/grafana/dashboards/{{ item }}"
    owner: grafana
    group: grafana
    mode: "0644"
  become: true
  loop:
    - linux-system-metrics.json
    - postgresql-metrics.json
    - webapp-overview.json
    - nginx-frontend-detailed.json
    - backend-application.json
  notify: restart grafana-server

# ── 8. Start and enable Grafana ──────────────────────────────
- name: Start and enable grafana-server
  ansible.builtin.systemd:
    name: grafana-server
    state: started
    enabled: true
  become: true

- name: Flush handlers (apply config changes)
  ansible.builtin.meta: flush_handlers

# ── 8. UFW firewall ──────────────────────────────────────────
- name: Check UFW status
  ansible.builtin.command:
    cmd: ufw status
  register: ufw_status
  changed_when: false
  become: true

- name: Add Grafana port to UFW
  ansible.builtin.shell: |
    ufw allow 3000/tcp
  when: "'3000' not in ufw_status.stdout"
  changed_when: true
  become: true

- name: Show UFW status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_final
  changed_when: false
  become: true

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_final.stdout_lines

# ── 9. Verification ──────────────────────────────────────────
- name: Wait for Grafana to start
  ansible.builtin.wait_for:
    port: 3000
    host: 127.0.0.1
    timeout: 30
    delay: 5

- name: Verify Grafana responds on HTTPS
  ansible.builtin.uri:
    url: "https://127.0.0.1:3000/api/health"
    validate_certs: false
    status_code: [200]
  register: grafana_health

- name: Display Grafana health status
  ansible.builtin.debug:
    msg: "Grafana HTTPS health: {{ grafana_health.json }}"
