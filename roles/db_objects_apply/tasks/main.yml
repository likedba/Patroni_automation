---
- name: Get patroni topology in JSON
  command: patronictl -c /etc/patroni.yml list --format json
  become_user: postgres
  register: patroni_topology
  changed_when: false
  run_once: true
  delegate_to: "{{ patroni1_hostname }}.{{ domain }}"

- name: Resolve current primary host ip
  set_fact:
    patroni_primary_host_ip: "{{ ((patroni_topology.stdout | from_json) | selectattr('Role', 'equalto', 'Leader') | map(attribute='Host') | list | first) }}"
  run_once: true

- name: Build ip-to-host mapping
  set_fact:
    patroni_ip_to_host:
      "{{ patroni1_ip }}": "{{ patroni1_hostname }}.{{ domain }}"
      "{{ patroni2_ip }}": "{{ patroni2_hostname }}.{{ domain }}"
      "{{ patroni3_ip }}": "{{ patroni3_hostname }}.{{ domain }}"
  run_once: true

- name: Ensure primary host was detected
  assert:
    that:
      - patroni_primary_host_ip is defined
      - patroni_ip_to_host[patroni_primary_host_ip] is defined
    fail_msg: "Could not detect active Patroni primary node."
  run_once: true

- name: Render DB objects SQL on primary host
  template:
    src: "{{ playbook_dir }}/../templates/patroni/db_objects.sql"
    dest: /tmp/db_objects.sql
    owner: postgres
    group: postgres
    mode: '0600'
  run_once: true
  delegate_to: "{{ patroni_ip_to_host[patroni_primary_host_ip] }}"

- name: Apply DB objects on primary host
  command: psql -f /tmp/db_objects.sql postgres
  become_user: postgres
  register: db_objects_apply_result
  changed_when: true
  run_once: true
  delegate_to: "{{ patroni_ip_to_host[patroni_primary_host_ip] }}"

- name: Show SQL apply output
  debug:
    var: db_objects_apply_result.stdout_lines
  run_once: true
