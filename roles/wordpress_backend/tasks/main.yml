---
# ── 1. System packages ───────────────────────────────────────
- name: Install WordPress backend packages
  ansible.builtin.apt:
    name:
      - nginx
      - php8.3-fpm
      - php8.3-pgsql
      - php8.3-curl
      - php8.3-gd
      - php8.3-mbstring
      - php8.3-xml
      - php8.3-xmlrpc
      - php8.3-soap
      - php8.3-intl
      - php8.3-zip
      - php8.3-mysql
      - postgresql-client
      - nfs-common
      - unzip
      - curl
      - git
      - net-tools
    state: present
    update_cache: true
  become: true

- name: Start and enable php8.3-fpm
  ansible.builtin.systemd:
    name: php8.3-fpm
    state: started
    enabled: true
  become: true

- name: Enable PHP-FPM status page for monitoring
  ansible.builtin.template:
    src: www-pool-status.conf.j2
    dest: /etc/php/8.3/fpm/pool.d/zz-status.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: restart php8.3-fpm

# ── 2. Web root ──────────────────────────────────────────────
- name: Create web root directory
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  become: true

# ── 3. NFS mount ─────────────────────────────────────────────
- name: Create wp-content/uploads mount point
  ansible.builtin.file:
    path: /var/www/html/wp-content/uploads
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  become: true

- name: Add NFS mount to /etc/fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: "{{ nfs_server_ip }}:/srv/nfs/wordpress/uploads"
    line: "{{ nfs_server_ip }}:/srv/nfs/wordpress/uploads /var/www/html/wp-content/uploads nfs vers=4,defaults,noatime,_netdev,nofail,x-systemd.automount 0 0"
    state: present
  become: true
  notify: daemon-reload

- name: Flush handlers (daemon-reload before mount)
  ansible.builtin.meta: flush_handlers

- name: Mount all filesystems from fstab
  ansible.builtin.command:
    cmd: mount -a
  changed_when: false
  become: true

# ── 4. Verify NFS mount ─────────────────────────────────────
- name: Verify NFS mount
  ansible.builtin.shell: df -h | grep nfs
  register: nfs_verify
  changed_when: false
  become: false

- name: Show NFS mount status
  ansible.builtin.debug:
    var: nfs_verify.stdout_lines

# ── 5. WordPress deployment ──────────────────────────────────
- name: Check if WordPress is already deployed
  ansible.builtin.stat:
    path: /var/www/html/wp-includes/version.php
  register: wp_deployed

- name: Download WordPress (force IPv4)
  ansible.builtin.shell:
    cmd: curl -4 -fsSL -o /tmp/wordpress-latest.tar.gz https://wordpress.org/latest.tar.gz
  when: not wp_deployed.stat.exists
  changed_when: true
  register: dl_wordpress
  retries: 3
  delay: 10
  until: dl_wordpress.rc == 0

- name: Extract WordPress archive
  ansible.builtin.unarchive:
    src: /tmp/wordpress-latest.tar.gz
    dest: /tmp/
    remote_src: true
  when: not wp_deployed.stat.exists

- name: Copy WordPress files to web root
  ansible.builtin.shell: |
    cp -r /tmp/wordpress/* /var/www/html/
    cp /tmp/wordpress/.htaccess /var/www/html/ 2>/dev/null || true
  when: not wp_deployed.stat.exists
  changed_when: true
  become: true

- name: Set WordPress ownership
  ansible.builtin.file:
    path: /var/www/html
    owner: www-data
    group: www-data
    recurse: true
  become: true

- name: Set WordPress directory permissions
  ansible.builtin.shell: find /var/www/html -type d -exec chmod 755 {} \;
  changed_when: false
  become: true

- name: Set WordPress file permissions
  ansible.builtin.shell: find /var/www/html -type f -exec chmod 644 {} \;
  changed_when: false
  become: true

- name: Ensure uploads directory is writable
  ansible.builtin.file:
    path: /var/www/html/wp-content/uploads
    mode: "0755"
  become: true

# ── 6. pg4wp plugin ──────────────────────────────────────────
- name: Check if pg4wp plugin is already deployed
  ansible.builtin.stat:
    path: /var/www/html/wp-content/pg4wp/driver_pgsql.php
  register: pg4wp_deployed

- name: Download pg4wp plugin (force IPv4)
  ansible.builtin.shell:
    cmd: curl -4 -fsSL -o /tmp/pg4wp-v3.3.1.tar.gz https://github.com/PostgreSQL-For-Wordpress/postgresql-for-wordpress/archive/refs/tags/v3.3.1.tar.gz
  when: not pg4wp_deployed.stat.exists
  changed_when: true
  register: dl_pg4wp
  retries: 3
  delay: 10
  until: dl_pg4wp.rc == 0

- name: Extract pg4wp archive
  ansible.builtin.unarchive:
    src: /tmp/pg4wp-v3.3.1.tar.gz
    dest: /tmp/
    remote_src: true
  when: not pg4wp_deployed.stat.exists

- name: Create pg4wp directory
  ansible.builtin.file:
    path: /var/www/html/wp-content/pg4wp
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  become: true

- name: Copy pg4wp files to wp-content
  ansible.builtin.shell: |
    cp -r /tmp/postgresql-for-wordpress-3.3.1/pg4wp/* /var/www/html/wp-content/pg4wp/
  when: not pg4wp_deployed.stat.exists
  changed_when: true
  become: true

- name: Set pg4wp ownership
  ansible.builtin.file:
    path: /var/www/html/wp-content/pg4wp
    owner: www-data
    group: www-data
    recurse: true
  become: true

# ── 7. Patch pg4wp driver for Patroni ────────────────────────
#   Patch both wpsqli_real_connect() and wpsqli_select_db() so that
#   EVERY connection path uses target_session_attrs=read-write.
- name: Patch pg4wp driver for Patroni primary-only connections
  ansible.builtin.shell: |
    DRIVER="/var/www/html/wp-content/pg4wp/driver_pgsql.php"
    if grep -q "Patroni: connect only to primary" "$DRIVER"; then
      echo "already_patched"
      exit 0
    fi
    perl -0777 -i -pe '
    # 1) wpsqli_real_connect(): insert before "// Must connect to a specific database"
    if (index($_, "function wpsqli_real_connect") >= 0 && index($_, "Patroni: connect only to primary") < 0) {
      s/(\n\s*\/\/ Must connect to a specific database unlike MySQL)/\n    \/\/ Patroni: connect only to primary (read-write) + faster failover\n    if (strpos(\$GLOBALS["pg4wp_connstr"], "target_session_attrs=") === false) {\n        \$GLOBALS["pg4wp_connstr"] .= " target_session_attrs=read-write connect_timeout=3";\n    }\n$1/s;
    }
    # 2) wpsqli_select_db(): insert after opening brace
    if (index($_, "function wpsqli_select_db") >= 0 && $_ !~ /function wpsqli_select_db.*?target_session_attrs=/s) {
      s/(function wpsqli_select_db.*?\{\n)/$1    \/\/ Patroni: connect only to primary (read-write) + faster failover\n    if (strpos(\$GLOBALS["pg4wp_connstr"], "target_session_attrs=") === false) {\n        \$GLOBALS["pg4wp_connstr"] .= " target_session_attrs=read-write connect_timeout=3";\n    }\n/s;
    }
    ' "$DRIVER"
    echo "patched"
  args:
    executable: /bin/bash
  register: pg4wp_patch
  changed_when: "'patched' in pg4wp_patch.stdout"
  become: true

- name: Verify pg4wp patch applied
  ansible.builtin.shell: grep -n "target_session_attrs=read-write" /var/www/html/wp-content/pg4wp/driver_pgsql.php
  register: pg4wp_patch_check
  changed_when: false
  become: true

- name: Show pg4wp patch verification
  ansible.builtin.debug:
    var: pg4wp_patch_check.stdout_lines

# ── 8. WordPress configuration ───────────────────────────────
- name: Deploy wp-config.php
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: /var/www/html/wp-config.php
    owner: www-data
    group: www-data
    mode: "0644"
  become: true

- name: Copy pg4wp db.php to wp-content
  ansible.builtin.copy:
    src: /var/www/html/wp-content/pg4wp/db.php
    dest: /var/www/html/wp-content/db.php
    remote_src: true
    owner: www-data
    group: www-data
    mode: "0644"
  become: true
  notify: restart php8.3-fpm

# ── 9. Nginx backend configuration ──────────────────────────
- name: Deploy nginx backend site config
  ansible.builtin.template:
    src: nginx-backend.conf.j2
    dest: /etc/nginx/sites-available/wordpress-backend
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: reload nginx

- name: Enable WordPress backend nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/wordpress-backend
    dest: /etc/nginx/sites-enabled/wordpress-backend
    state: link
  become: true
  notify: reload nginx

- name: Remove nginx default site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: true
  notify: reload nginx

- name: Flush handlers (apply nginx + php-fpm before WP install)
  ansible.builtin.meta: flush_handlers

# ── 10. WP-CLI ───────────────────────────────────────────────
- name: Check if WP-CLI is installed
  ansible.builtin.stat:
    path: /usr/local/bin/wp
  register: wpcli_stat

- name: Download and install WP-CLI (force IPv4)
  ansible.builtin.shell:
    cmd: curl -4 -fsSL -o /usr/local/bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod 0755 /usr/local/bin/wp
  when: not wpcli_stat.stat.exists
  become: true
  changed_when: true
  register: dl_wpcli
  retries: 3
  delay: 10
  until: dl_wpcli.rc == 0

# ── 11. WordPress core install (first backend only) ──────────
- name: Check if WordPress core is already installed
  ansible.builtin.command:
    cmd: wp core is-installed --allow-root --path=/var/www/html
  register: wp_core_check
  failed_when: false
  changed_when: false
  run_once: true
  become: true

- name: Install WordPress core
  ansible.builtin.command:
    cmd: >
      wp core install
      --allow-root
      --path=/var/www/html
      --url="{{ wp_site_url }}"
      --title="{{ wp_site_title }}"
      --admin_user="{{ wp_admin_user }}"
      --admin_password="{{ wp_admin_pass }}"
      --admin_email="{{ wp_admin_email }}"
  when: wp_core_check.rc != 0
  run_once: true
  changed_when: true
  become: true
  no_log: true

# ── 12. Deploy project homepage ────────────────────────────────
- name: Deploy homepage HTML template
  ansible.builtin.template:
    src: homepage.html.j2
    dest: /tmp/homepage.html
    mode: "0644"
  run_once: true
  become: true

- name: Get existing homepage page ID
  ansible.builtin.shell: |
    wp post list --allow-root --path=/var/www/html \
      --post_type=page --post_status=publish \
      --fields=ID,post_title --format=csv | \
      grep ",Patroni Automation$" | head -1 | cut -d',' -f1
  register: homepage_check
  run_once: true
  failed_when: false
  changed_when: false
  become: true

- name: Create homepage in WordPress
  ansible.builtin.shell: |
    wp post create /tmp/homepage.html \
      --allow-root --path=/var/www/html \
      --post_type=page --post_status=publish \
      --post_title="Patroni Automation" \
      --porcelain
  register: homepage_created
  when: homepage_check.stdout | trim | length == 0
  run_once: true
  changed_when: true
  become: true

- name: Update existing homepage content
  ansible.builtin.shell: |
    wp post update {{ homepage_check.stdout | trim }} /tmp/homepage.html \
      --allow-root --path=/var/www/html
  when: homepage_check.stdout | trim | length > 0
  run_once: true
  changed_when: true
  become: true

- name: Set homepage page ID
  ansible.builtin.set_fact:
    homepage_page_id: "{{ homepage_created.stdout | default(homepage_check.stdout) | trim }}"
  run_once: true

- name: Set static front page
  ansible.builtin.shell: |
    wp option update show_on_front 'page' --allow-root --path=/var/www/html
    wp option update page_on_front '{{ homepage_page_id }}' --allow-root --path=/var/www/html
  when: homepage_page_id | length > 0
  run_once: true
  changed_when: true
  become: true

- name: Clean up homepage temp file
  ansible.builtin.file:
    path: /tmp/homepage.html
    state: absent
  run_once: true
  become: true

# ── 13. UFW firewall ─────────────────────────────────────────
- name: Check UFW status
  ansible.builtin.command:
    cmd: ufw status
  register: ufw_status
  changed_when: false
  become: true

- name: Configure UFW firewall rules
  ansible.builtin.shell: |
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp
    ufw allow from {{ wp_frontend_ip }} to any port 8080 proto tcp
    ufw deny 8080/tcp
    ufw --force enable
  when: "'8080' not in ufw_status.stdout"
  changed_when: true
  become: true

- name: Show UFW status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_final
  changed_when: false
  become: true

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_final.stdout_lines
