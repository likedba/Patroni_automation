---
- name: Check if cluster passwords already exist in Vault
  ansible.builtin.command:
    cmd: vault kv get secret/patroni_dpl/{{ project_name }}/
  register: vault_check
  failed_when: false
  changed_when: false

- name: Generate and store cluster passwords in Vault
  ansible.builtin.shell: |
    vault kv put secret/patroni_dpl/{{ project_name }}/ \
      admin_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      replicator_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      rewind_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      postgres_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      {{ app_user }}_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      wp_admin_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      zabbix_db_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      grafana_db_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      zbx_monitor_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24) \
      zabbix_admin_pass=zabbix
  when: vault_check.rc != 0
  changed_when: true

- name: Show Vault path for cluster passwords
  ansible.builtin.debug:
    msg: "Cluster passwords stored at: secret/patroni_dpl/{{ project_name }}/"
  when: vault_check.rc != 0

# If the path already exists, ensure app_user password is present (e.g. after app_user rename)
- name: Check if app user password exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field={{ app_user }}_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_app_user_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add app user password to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      {{ app_user }}_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24)
  when: vault_check.rc == 0 and vault_app_user_check.rc != 0
  changed_when: true

# Ensure wp_admin_pass exists (for WordPress admin user)
- name: Check if wp_admin_pass exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field=wp_admin_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_wp_admin_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add wp_admin_pass to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      wp_admin_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24)
  when: vault_check.rc == 0 and vault_wp_admin_check.rc != 0
  changed_when: true

# ── Monitoring stack passwords ──────────────────────────────
# Ensure zabbix_db_pass exists
- name: Check if zabbix_db_pass exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field=zabbix_db_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_zabbix_db_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add zabbix_db_pass to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      zabbix_db_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24)
  when: vault_check.rc == 0 and vault_zabbix_db_check.rc != 0
  changed_when: true

# Ensure grafana_db_pass exists
- name: Check if grafana_db_pass exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field=grafana_db_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_grafana_db_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add grafana_db_pass to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      grafana_db_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24)
  when: vault_check.rc == 0 and vault_grafana_db_check.rc != 0
  changed_when: true

# Ensure zbx_monitor_pass exists
- name: Check if zbx_monitor_pass exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field=zbx_monitor_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_zbx_monitor_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add zbx_monitor_pass to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      zbx_monitor_pass=$(openssl rand -base64 18 | tr -dc 'a-zA-Z0-9' | head -c 24)
  when: vault_check.rc == 0 and vault_zbx_monitor_check.rc != 0
  changed_when: true

# Ensure zabbix_admin_pass exists (Zabbix web UI Admin password)
- name: Check if zabbix_admin_pass exists in Vault
  ansible.builtin.command:
    cmd: vault kv get -field=zabbix_admin_pass secret/patroni_dpl/{{ project_name }}/
  register: vault_zabbix_admin_check
  failed_when: false
  changed_when: false
  when: vault_check.rc == 0

- name: Add zabbix_admin_pass to existing Vault entry
  ansible.builtin.shell: |
    vault kv patch secret/patroni_dpl/{{ project_name }}/ \
      zabbix_admin_pass=zabbix
  when: vault_check.rc == 0 and vault_zabbix_admin_check.rc != 0
  changed_when: true
