---
# ── 1. Install Python dependency for community.zabbix ──────
- name: Install zabbix_utils Python package
  ansible.builtin.pip:
    name: zabbix_utils
    state: present
  delegate_to: localhost

# ── 2. Create host groups ──────────────────────────────────
- name: Create Zabbix host groups
  community.zabbix.zabbix_group:
    host_groups:
      - "{{ item }}"
    state: present
  loop: "{{ zabbix_host_groups }}"

# ── 3. Register hosts ─────────────────────────────────────
- name: Register hosts in Zabbix
  community.zabbix.zabbix_host:
    host_name: "{{ item.name }}"
    host_groups: "{{ item.groups }}"
    link_templates: "{{ item.templates }}"
    interfaces:
      - type: agent
        main: 1
        useip: 1
        ip: "{{ item.ip }}"
        port: "10050"
    status: enabled
    state: present
  loop: "{{ zabbix_hosts }}"
  loop_control:
    label: "{{ item.name }}"
