---
# Create .pgpass for postgres user on all patroni nodes
- name: Deploy .pgpass for postgres user
  ansible.builtin.template:
    src: pgpass.j2
    dest: /var/lib/postgresql/.pgpass
    owner: postgres
    group: postgres
    mode: '0600'
  become: true

# Run psql commands via read-write connection string â€” psql finds the primary automatically
- name: Create application user in PostgreSQL (idempotent via DO block)
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "DO \$\$ BEGIN CREATE USER {{ app_user }} WITH PASSWORD '{{ app_user_pass }}'; EXCEPTION WHEN duplicate_object THEN NULL; END \$\$;"
  run_once: true
  changed_when: false
  become: true

- name: Check if application database already exists
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -tc "SELECT 1 FROM pg_database WHERE datname='{{ app_db_name }}'"
  register: db_check
  run_once: true
  changed_when: false
  become: true

- name: Create application database in PostgreSQL
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "CREATE DATABASE {{ app_db_name }} OWNER {{ app_user }};"
  when: "'1' not in db_check.stdout"
  run_once: true
  changed_when: true
  become: true

# Create backup user for pg_probackup (idempotent via DO block)
- name: Create backup user in PostgreSQL
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "DO \$\$ BEGIN CREATE USER backup REPLICATION PASSWORD '{{ backup_pass }}'; EXCEPTION WHEN duplicate_object THEN NULL; END \$\$;"
  run_once: true
  changed_when: false
  become: true

- name: Update backup user password (sync with Vault)
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "ALTER USER backup WITH PASSWORD '{{ backup_pass }}';"
  run_once: true
  changed_when: false
  no_log: true
  become: true

- name: Grant pg_catalog permissions to backup user (postgres DB)
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "
        GRANT USAGE ON SCHEMA pg_catalog TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.current_setting(text) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_is_in_recovery() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_backup_start(text, boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_backup_stop(boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_create_restore_point(text) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_switch_wal() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_last_wal_replay_lsn() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_current() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_current_snapshot() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_snapshot_xmax(txid_snapshot) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_control_checkpoint() TO backup;
      "
  run_once: true
  changed_when: false
  become: true

- name: Verify {{ app_db_name }} exists on primary before granting
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -tc "SELECT 1 FROM pg_database WHERE datname='{{ app_db_name }}'"
  register: db_verify
  run_once: true
  changed_when: false
  become: true
  retries: 6
  delay: 5
  until: "'1' in db_verify.stdout"

- name: Grant pg_catalog permissions to backup user ({{ app_db_name }} DB)
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname={{ app_db_name }} user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "
        GRANT USAGE ON SCHEMA pg_catalog TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.current_setting(text) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_is_in_recovery() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_backup_start(text, boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_backup_stop(boolean) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_create_restore_point(text) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_switch_wal() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_last_wal_replay_lsn() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_current() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_current_snapshot() TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.txid_snapshot_xmax(txid_snapshot) TO backup;
        GRANT EXECUTE ON FUNCTION pg_catalog.pg_control_checkpoint() TO backup;
      "
  register: grant_appdb
  run_once: true
  changed_when: false
  become: true
  retries: 6
  delay: 5
  until: grant_appdb.rc == 0

# Create pdc.yml and apply Patroni DCS config (run once from first node)
- name: Deploy Patroni DCS config file
  ansible.builtin.template:
    src: pdc.yml.j2
    dest: /pgdata/patroni/pdc.yml
    owner: postgres
    group: postgres
    mode: '0640'
  run_once: true
  become: true

- name: Apply Patroni DCS configuration
  ansible.builtin.shell:
    cmd: patronictl -c /etc/patroni/config.yml edit-config --replace /pgdata/patroni/pdc.yml --force --quiet
  run_once: true
  changed_when: true
  become: true

- name: Restart Patroni cluster to apply new DCS configuration
  ansible.builtin.shell:
    cmd: patronictl -c /etc/patroni/config.yml restart {{ project_name }}-cluster --force
  run_once: true
  changed_when: true
  become: true
