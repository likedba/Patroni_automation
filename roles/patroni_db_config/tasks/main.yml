---
# Create .pgpass for postgres user on all patroni nodes
- name: Deploy .pgpass for postgres user
  ansible.builtin.template:
    src: pgpass.j2
    dest: /var/lib/postgresql/.pgpass
    owner: postgres
    group: postgres
    mode: '0600'
  become: true

# Run psql commands via read-write connection string â€” psql finds the primary automatically
- name: Create application user in PostgreSQL (idempotent via DO block)
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "DO \$\$ BEGIN CREATE USER {{ app_user }} WITH PASSWORD '{{ app_user_pass }}'; EXCEPTION WHEN duplicate_object THEN NULL; END \$\$;"
  run_once: true
  changed_when: false
  become: true

- name: Check if application database already exists
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -tc "SELECT 1 FROM pg_database WHERE datname='{{ app_db_name }}'"
  register: db_check
  run_once: true
  changed_when: false
  become: true

- name: Create application database in PostgreSQL
  ansible.builtin.shell: |
    sudo -u postgres psql \
      "host={{ node1_ip }},{{ node2_ip }},{{ node3_ip }} port=5432 dbname=postgres user=postgres target_session_attrs=read-write connect_timeout=3" \
      -c "CREATE DATABASE {{ app_db_name }} OWNER {{ app_user }};"
  when: "'1' not in db_check.stdout"
  run_once: true
  changed_when: true
  become: true

# Create pdc.yml and apply Patroni DCS config (run once from first node)
- name: Deploy Patroni DCS config file
  ansible.builtin.template:
    src: pdc.yml.j2
    dest: /pgdata/patroni/pdc.yml
    owner: postgres
    group: postgres
    mode: '0640'
  run_once: true
  become: true

- name: Apply Patroni DCS configuration
  ansible.builtin.shell:
    cmd: patronictl -c /etc/patroni/config.yml edit-config --replace /pgdata/patroni/pdc.yml --force --quiet
  run_once: true
  changed_when: true
  become: true

- name: Restart Patroni cluster to apply new DCS configuration
  ansible.builtin.shell:
    cmd: patronictl -c /etc/patroni/config.yml restart {{ project_name }}-cluster --force
  run_once: true
  changed_when: true
  become: true
