---
# Common project variables
project_name: "autopatroni"
domain: "infra.local"

# Hardware parameters
cpu: 1
ram: 2  # in GB
disk: 50 # in GB

# Patroni hosts
patroni1_hostname: "vmpatronidb-1"
patroni2_hostname: "vmpatronidb-2"
patroni3_hostname: "vmpatronidb-3"
patroni1_ip: "192.168.1.135"
patroni2_ip: "192.168.1.136"
patroni3_ip: "192.168.1.137"

# Host FQDNs
patroni1_fqdn: "{{ patroni1_hostname }}.{{ domain }}"
patroni2_fqdn: "{{ patroni2_hostname }}.{{ domain }}"
patroni3_fqdn: "{{ patroni3_hostname }}.{{ domain }}"

# PostgreSQL version
pg_major_version: 15

# Database objects
app_db_name: "{{ project_name }}"
app_schema_name: "{{ project_name }}"
app_user: "{{ project_name }}"

# PostgreSQL settings (calculated parameters)
# RAM in MB for calculations
ram_mb: "{{ ram * 1024 }}"

# shared_buffers
shared_buffers: >-
  {% if ram < 4 -%}
  {{ (ram_mb / 4) | int }}MB
  {%- else -%}
  {{ (ram / 4) | int }}GB
  {%- endif %}

# work_mem
work_mem: "{% if ram < 64 %}32MB{% else %}64MB{% endif %}"

# maintenance_work_mem
maintenance_work_mem: >-
  {% if ram < 32 -%}
  320MB
  {%- elif ram >= 32 and ram < 64 -%}
  420MB
  {%- else -%}
  640MB
  {%- endif %}

# effective_cache_size
effective_cache_size: >-
  {% if ram < 4 -%}
  {{ (ram_mb * 0.7) | round(0) | int }}MB
  {%- else -%}
  {{ (ram * 0.7) | round(0) | int }}GB
  {%- endif %}

# Other PostgreSQL parameters
cpu_half: "{{ ((cpu + 1) / 2) | int }}"
archive_command: "/bin/true"
extensions: "pg_stat_statements"

# IP addresses for pg_hba.conf
dba1_ip: ""
dba2_ip: ""
dba3_ip: ""
dba4_ip: ""
app1_ip: ""
app2_ip: ""
app3_ip: ""
app4_ip: ""
app5_ip: ""
app6_ip: ""

# Variables to be loaded from Vault
# They are defined here as empty but will be populated when using the vault lookup plugin
vault_secrets:
  zabbix_monitor_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:zbx_monitor_password') }}"
  app_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:app_user_password') }}"
  postgres_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:postgres_user_password') }}"
  ppem_agent_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:ppem_agent_user_password') }}"
  otel_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:otel_user_password') }}"
  backup_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:backup_user_password') }}"
  postgres_exporter_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:postgres_exporter_user_password') }}"
  zbx_monitor_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:zbx_monitor_user_password') }}"
  auditor_user_password: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:auditor_user_password') }}"
  ppem_api_key: "{{ lookup('hashi_vault', 'secret=secret/{{ project_name }}/postgres:ppem_api_key') }}"

# For convenience, separate variables can be created
zbx_monitor_password: "{{ vault_secrets.zabbix_monitor_password }}"
app_user_pass: "{{ vault_secrets.app_user_password }}"
postgres_user_pass: "{{ vault_secrets.postgres_user_password }}"
ppem_agent_user_pass: "{{ vault_secrets.ppem_agent_user_password }}"
otel_user_pass: "{{ vault_secrets.otel_user_password }}"
backup_user_pass: "{{ vault_secrets.backup_user_password }}"
postgres_exporter_user_pass: "{{ vault_secrets.postgres_exporter_user_password }}"
zbx_monitor_user_pass: "{{ vault_secrets.zbx_monitor_user_password }}"
auditor_user_pass: "{{ vault_secrets.auditor_user_password }}"
ppem_api_key: "{{ vault_secrets.ppem_api_key }}"
