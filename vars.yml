---
# =========================
# Project
# =========================
domain: "infra.local"

# =========================
# Cluster settings
# =========================
project_name: "test"
app_user: "wp_user"
app_db_name: "wordpress_db"

# Servers allowed to connect to app_db_name (for pg_hba)
app_servers:
  - { name: "vmubuntu-3", ip: "192.168.1.143" }
  - { name: "vmubuntu-4", ip: "192.168.1.144" }

# Derived from patroni_vms — do not edit directly
node1_hostname: "{{ patroni_vms[0].name }}"
node2_hostname: "{{ patroni_vms[1].name }}"
node3_hostname: "{{ patroni_vms[2].name }}"
node1_ip: "{{ patroni_vms[0].ip }}"
node2_ip: "{{ patroni_vms[1].ip }}"
node3_ip: "{{ patroni_vms[2].ip }}"

# =========================
# vCenter
# =========================
vcenter_hostname: "vcenter"                        # 192.168.1.140
vcenter_username: "administrator@vsphere.local"
vcenter_validate_certs: false
vcenter_datacenter: "Home Lab"
vcenter_datastore: "datastore1"
vcenter_folder: "/Home Lab/vm"
vcenter_network: "VM Network"
vcenter_template: "ubuntu_template"
vcenter_esxi_host: "192.168.1.83"                  # физический ESXi хост внутри vCenter (зарегистрирован по IP)

# =========================
# VM hardware
# Disk не указываем — наследуется из шаблона
# =========================
vm_cpu: 2
vm_ram_mb: 2048
vm_hardware_version: 21
vm_guest_id: "ubuntu64Guest"

# =========================
# VM network
# =========================
vm_netmask: "255.255.255.0"
vm_gateway: "192.168.1.1"
vm_dns_servers:
  - "192.168.1.146"

# =========================
# Patroni VMs
# =========================
patroni_vms:
  - { name: "vmpatronidb-1", ip: "192.168.1.135" }
  - { name: "vmpatronidb-2", ip: "192.168.1.136" }
  - { name: "vmpatronidb-3", ip: "192.168.1.137" }

# =========================
# Infra VMs
# =========================
infra_vms:
  - { name: "vmubuntu-1", ip: "192.168.1.141" }
  - { name: "vmubuntu-2", ip: "192.168.1.142" }
  - { name: "vmubuntu-3", ip: "192.168.1.143" }
  - { name: "vmubuntu-4", ip: "192.168.1.144" }
  - { name: "vmubuntu-5", ip: "192.168.1.145" }
  - { name: "vmubuntu-7", ip: "192.168.1.147" }
  - { name: "vmubuntu-8", ip: "192.168.1.148" }

# =========================
# Vault secrets (secret/patroni_dpl)
# =========================
vcenter_password: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=esxi_pass secret/patroni_dpl') | trim }}"
aleksei_user_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=aleksei_user_pass secret/patroni_dpl') | trim }}"

# =========================
# Vault secrets — cluster passwords (secret/patroni_dpl/<project_name>/)
# =========================
admin_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=admin_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
replicator_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=replicator_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
postgres_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=postgres_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
rewind_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=rewind_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
app_user_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=' ~ app_user ~ '_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
wp_admin_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=wp_admin_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"

# =========================
# NFS / WordPress infra
# =========================
nfs_server_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-5') | map(attribute='ip') | first }}"
wp_frontend_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-1') | map(attribute='ip') | first }}"
wp_site_url: "https://{{ wp_frontend_ip }}:4433"
wp_site_title: "Aleksei's Project"
wp_admin_user: "aleksei"
wp_admin_email: "a.salugin@gmail.com"

# =========================
# Monitoring stack (Zabbix + Grafana on vmubuntu-8)
# =========================
monitoring_host_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-8') | map(attribute='ip') | first }}"
monitoring_pg_port: 5432
monitoring_pg_conf_dir: "/etc/postgresql/18/main"

monitoring_databases:
  - { name: "zabbix",  owner: "zabbix",  pass_var: "zabbix_db_pass" }
  - { name: "grafana", owner: "grafana", pass_var: "grafana_db_pass" }

zabbix_db_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=zabbix_db_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
grafana_db_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=grafana_db_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
zbx_monitor_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=zbx_monitor_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
zabbix_admin_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=zabbix_admin_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"

# =========================
# Backup (pg_probackup on vmubuntu-5)
# =========================
backup_server_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-5') | map(attribute='ip') | first }}"
backup_pass: "{{ lookup('ansible.builtin.pipe', 'vault kv get -field=backup_pass secret/patroni_dpl/' ~ project_name ~ '/') | trim }}"
backup_replica_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-2') | map(attribute='ip') | first }}"

# =========================
# ELK Stack (vmubuntu-7)
# =========================
elk_version: "8.17.0"
elk_host_ip: "{{ infra_vms | selectattr('name', 'equalto', 'vmubuntu-7') | map(attribute='ip') | first }}"
es_heap_size: "1g"
ls_heap_size: "512m"

# =========================
# Zabbix host registration
# =========================
zabbix_host_groups:
  - "Linux servers"
  - "Patroni Cluster"
  - "Web Frontend"
  - "WordPress Backends"
  - "NFS Servers"
  - "DNS"
  - "Monitoring Stack"
  - "ELK Stack"
  - "Backup Servers"

zabbix_hosts:
  - name: vmpatronidb-1
    ip: "192.168.1.135"
    groups: ["Linux servers", "Patroni Cluster"]
    templates: ["Linux by Zabbix agent", "PostgreSQL by Zabbix agent 2"]
    macros:
      - macro: "{$PG.USER}"
        value: "zbx_monitor"
      - macro: "{$PG.PASSWORD}"
        value: "{{ zbx_monitor_pass }}"
        type: secret
      - macro: "{$PG.DATABASE}"
        value: "postgres"
  - name: vmpatronidb-2
    ip: "192.168.1.136"
    groups: ["Linux servers", "Patroni Cluster"]
    templates: ["Linux by Zabbix agent", "PostgreSQL by Zabbix agent 2"]
    macros:
      - macro: "{$PG.USER}"
        value: "zbx_monitor"
      - macro: "{$PG.PASSWORD}"
        value: "{{ zbx_monitor_pass }}"
        type: secret
      - macro: "{$PG.DATABASE}"
        value: "postgres"
  - name: vmpatronidb-3
    ip: "192.168.1.137"
    groups: ["Linux servers", "Patroni Cluster"]
    templates: ["Linux by Zabbix agent", "PostgreSQL by Zabbix agent 2"]
    macros:
      - macro: "{$PG.USER}"
        value: "zbx_monitor"
      - macro: "{$PG.PASSWORD}"
        value: "{{ zbx_monitor_pass }}"
        type: secret
      - macro: "{$PG.DATABASE}"
        value: "postgres"
  - name: vmubuntu-1
    ip: "192.168.1.141"
    groups: ["Linux servers", "Web Frontend"]
    templates: ["Linux by Zabbix agent", "Nginx by Zabbix agent 2"]
  - name: vmubuntu-2
    ip: "192.168.1.142"
    groups: ["Linux servers"]
    templates: ["Linux by Zabbix agent"]
  - name: vmubuntu-3
    ip: "192.168.1.143"
    groups: ["Linux servers", "WordPress Backends"]
    templates: ["Linux by Zabbix agent", "Nginx by Zabbix agent 2", "PHP-FPM by Zabbix agent"]
    macros:
      - macro: "{$NGINX.STUB_STATUS.PORT}"
        value: "8080"
      - macro: "{$PHP_FPM.HOST}"
        value: "127.0.0.1"
      - macro: "{$PHP_FPM.PORT}"
        value: "8080"
      - macro: "{$PHP_FPM.STATUS.PAGE}"
        value: "php-fpm-status"
  - name: vmubuntu-4
    ip: "192.168.1.144"
    groups: ["Linux servers", "WordPress Backends"]
    templates: ["Linux by Zabbix agent", "Nginx by Zabbix agent 2", "PHP-FPM by Zabbix agent"]
    macros:
      - macro: "{$NGINX.STUB_STATUS.PORT}"
        value: "8080"
      - macro: "{$PHP_FPM.HOST}"
        value: "127.0.0.1"
      - macro: "{$PHP_FPM.PORT}"
        value: "8080"
      - macro: "{$PHP_FPM.STATUS.PAGE}"
        value: "php-fpm-status"
  - name: vmubuntu-5
    ip: "192.168.1.145"
    groups: ["Linux servers", "NFS Servers", "Backup Servers"]
    templates: ["Linux by Zabbix agent"]
  - name: vmubuntu-6
    ip: "192.168.1.146"
    groups: ["Linux servers", "DNS"]
    templates: ["Linux by Zabbix agent"]
  - name: vmubuntu-7
    ip: "192.168.1.147"
    groups: ["Linux servers", "ELK Stack"]
    templates: ["Linux by Zabbix agent"]
  - name: vmubuntu-8
    ip: "192.168.1.148"
    groups: ["Linux servers", "Monitoring Stack"]
    templates: ["Linux by Zabbix agent", "PostgreSQL by Zabbix agent 2"]
    macros:
      - macro: "{$PG.USER}"
        value: "zbx_monitor"
      - macro: "{$PG.PASSWORD}"
        value: "{{ zbx_monitor_pass }}"
        type: secret
      - macro: "{$PG.DATABASE}"
        value: "postgres"
