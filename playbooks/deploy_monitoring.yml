---
# ─────────────────────────────────────────────────────────────
# Monitoring stack deployment
#
# Phase 1: PostgreSQL 18 standalone for Zabbix + Grafana
# Phase 2: Zabbix Server 7.4 + Web (HTTPS)
# Phase 3: Grafana (HTTPS :3000)
# Phase 4+5: zabbix-agent2 on all hosts + PostgreSQL plugin on DB nodes
# Phase 6: Auto-register hosts in Zabbix via API
#
# Run all:            ansible-playbook playbooks/deploy_monitoring.yml
# PostgreSQL only:    ansible-playbook playbooks/deploy_monitoring.yml --tags postgres
# Zabbix only:        ansible-playbook playbooks/deploy_monitoring.yml --tags zabbix
# Grafana only:       ansible-playbook playbooks/deploy_monitoring.yml --tags grafana
# Agent2 only:        ansible-playbook playbooks/deploy_monitoring.yml --tags agent2
# Register only:      ansible-playbook playbooks/deploy_monitoring.yml --tags register
# Alerts only:        ansible-playbook playbooks/deploy_monitoring.yml --tags alerts
# ─────────────────────────────────────────────────────────────

- name: Ensure monitoring passwords exist in Vault
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Ensure vault passwords are up to date
      include_role:
        name: vault_passwords

- name: Deploy PostgreSQL 18 for monitoring stack
  hosts: monitoring
  gather_facts: false
  become: true
  tags: [postgres]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Install and configure PostgreSQL 18
      include_role:
        name: monitoring_postgres

- name: Deploy Zabbix Server 7.4 + Web
  hosts: monitoring
  gather_facts: false
  become: true
  tags: [zabbix]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Install and configure Zabbix Server + Web
      include_role:
        name: zabbix_server

- name: Deploy Grafana
  hosts: monitoring
  gather_facts: false
  become: true
  tags: [grafana]
  vars_files:
    - "{{ playbook_dir }}/../vars.yml"
  vars:
    ansible_become_password: "{{ aleksei_user_pass }}"
  tasks:
    - name: Install and configure Grafana
      include_role:
        name: grafana

- name: Deploy zabbix-agent2 on all hosts
  hosts: infra:dns:patroni_nodes
  gather_facts: false
  become: true
  tags: [agent2]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Install and configure zabbix-agent2
      include_role:
        name: zabbix_agent2

- name: Register hosts in Zabbix via API
  hosts: zabbix_api
  gather_facts: false
  tags: [register]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Set Zabbix API password
      set_fact:
        ansible_httpapi_pass: "{{ zabbix_admin_pass }}"
      no_log: true
  tasks:
    - name: Register hosts in Zabbix
      include_role:
        name: zabbix_register

# ── Phase 7: Configure Zabbix alerts (triggers + email) ──────
- name: Configure Zabbix alerts and email notifications
  hosts: zabbix_api
  gather_facts: false
  tags: [alerts]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Set Zabbix API password
      set_fact:
        ansible_httpapi_pass: "{{ zabbix_admin_pass }}"
      no_log: true
  tasks:
    - name: Configure Zabbix alerts
      include_role:
        name: zabbix_alerts
