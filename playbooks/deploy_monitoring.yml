---
# ─────────────────────────────────────────────────────────────
# Monitoring stack deployment
#
# Phase 1: PostgreSQL 18 standalone for Zabbix + Grafana
# Phase 2: Zabbix Server + Web (future)
# Phase 3: Grafana (future)
# Phase 4: zabbix-agent2 on all hosts (future)
#
# Run all:            ansible-playbook playbooks/deploy_monitoring.yml
# PostgreSQL only:    ansible-playbook playbooks/deploy_monitoring.yml --tags postgres
# ─────────────────────────────────────────────────────────────

- name: Ensure monitoring passwords exist in Vault
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Ensure vault passwords are up to date
      include_role:
        name: vault_passwords

- name: Deploy PostgreSQL 18 for monitoring stack
  hosts: monitoring
  gather_facts: false
  become: true
  tags: [postgres]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Install and configure PostgreSQL 18
      include_role:
        name: monitoring_postgres
