---
- name: Prepare autogenerated Patroni DB secrets in Vault
  hosts: localhost
  gather_facts: false
  vars:
    vault_secret_path: "secret/patroni_dpl"
    autogenerated_secret_fields:
      - admin_user_pass
      - replicator_user_pass
      - postgres_user_pass
      - rewind_user_pass
      - app_user_pass
      - backup_user_pass
      - postgres_exporter_user_pass
      - zbx_monitor_user_pass
      - otel_user_pass
      - ppem_agent_user_pass
      - auditor_user_pass
  tasks:
    - name: Validate vault CLI is available
      command: vault --version
      register: vault_cli_version
      changed_when: false

    - name: Check if vault secret path exists
      command: "vault kv get {{ vault_secret_path }}"
      register: vault_path_check
      changed_when: false
      failed_when: false
      no_log: true

    - name: Initialize vault secret path when missing
      command: "vault kv put {{ vault_secret_path }} _initialized=true"
      when: vault_path_check.rc != 0
      no_log: true

    - name: Check whether autogenerated fields already exist
      command: "vault kv get -field={{ item }} {{ vault_secret_path }}"
      loop: "{{ autogenerated_secret_fields }}"
      register: autogenerated_field_checks
      changed_when: false
      failed_when: false
      no_log: true

    - name: Build missing fields list
      set_fact:
        missing_autogenerated_fields: >-
          {{ autogenerated_field_checks.results
          | selectattr('rc', 'ne', 0)
          | map(attribute='item')
          | list }}

    - name: Generate random values for missing fields
      shell: "openssl rand -base64 32 | tr -d '\n'"
      loop: "{{ missing_autogenerated_fields }}"
      register: generated_secret_values
      changed_when: true
      no_log: true
      when: missing_autogenerated_fields | length > 0

    - name: Patch generated values into Vault
      command: >-
        vault kv patch {{ vault_secret_path }}
        {{ item.item }}={{ item.stdout | quote }}
      loop: "{{ generated_secret_values.results | default([]) }}"
      no_log: true
      when: missing_autogenerated_fields | length > 0

    - name: Report result
      debug:
        msg: >-
          Vault preparation completed. Created {{ missing_autogenerated_fields | length }}
          missing secrets in {{ vault_secret_path }}.
