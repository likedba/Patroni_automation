---
# ─────────────────────────────────────────────────────────────
# WordPress stack deployment
#
# Run all:          ansible-playbook playbooks/deploy_wordpress.yml
# NFS only:         ansible-playbook playbooks/deploy_wordpress.yml --tags nfs
# Backends only:    ansible-playbook playbooks/deploy_wordpress.yml --tags backends
# Frontend only:    ansible-playbook playbooks/deploy_wordpress.yml --tags frontend
# DR Dashboard:     ansible-playbook playbooks/deploy_wordpress.yml --tags dr_dashboard
# ─────────────────────────────────────────────────────────────

- name: Ensure WordPress passwords exist in Vault
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Ensure vault passwords are up to date
      include_role:
        name: vault_passwords

- name: Deploy NFS server for WordPress shared storage
  hosts: nfs_servers
  gather_facts: false
  become: true
  tags: [nfs]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Configure NFS server
      include_role:
        name: nfs_server

- name: Deploy WordPress backends
  hosts: wordpress_backends
  gather_facts: false
  become: true
  tags: [backends]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Configure WordPress backend
      include_role:
        name: wordpress_backend

- name: Generate infrastructure CA on control node
  hosts: localhost
  gather_facts: false
  become: true
  tags: [frontend]
  tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Generate infrastructure CA
      include_role:
        name: infra_ca

- name: Deploy nginx frontend (reverse proxy + SSL)
  hosts: nginx_frontend
  gather_facts: false
  become: true
  tags: [frontend]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Configure nginx frontend
      include_role:
        name: nginx_frontend

# ─────────────────────────────────────────────────────────────
# DR Dashboard plugin deployment
# ─────────────────────────────────────────────────────────────
- name: Deploy DR Dashboard plugin
  hosts: wordpress_backends
  gather_facts: false
  become: true
  tags: [dr_dashboard]
  pre_tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"
      become: false

    - name: Set become password from vault
      set_fact:
        ansible_become_password: "{{ aleksei_user_pass }}"
      become: false
      no_log: true
  tasks:
    - name: Deploy DR Dashboard
      include_role:
        name: dr_dashboard

# ─────────────────────────────────────────────────────────────
# VERIFY: smoke test from control node
# ─────────────────────────────────────────────────────────────
- name: Verify WordPress stack is working
  hosts: localhost
  gather_facts: false
  tags: [always]
  tasks:
    - name: Load project variables
      include_vars:
        file: "{{ playbook_dir }}/../vars.yml"

    - name: Test HTTP → HTTPS redirect
      ansible.builtin.uri:
        url: "http://{{ wp_frontend_ip }}/"
        follow_redirects: none
        status_code: 301
      register: http_check

    - name: Show HTTP redirect result
      ansible.builtin.debug:
        msg: "HTTP redirect: {{ http_check.status }} → {{ http_check.location }}"

    - name: Test HTTPS endpoint
      ansible.builtin.uri:
        url: "{{ wp_site_url }}/"
        validate_certs: false
        status_code: [200, 302]
      register: https_check

    - name: Show HTTPS result
      ansible.builtin.debug:
        msg: "HTTPS status: {{ https_check.status }}, X-Frontend: {{ https_check.x_frontend | default('not set') }}"

    - name: Copy CA certificate to project directory
      ansible.builtin.copy:
        src: /opt/infra-ca/ca.crt
        dest: "{{ playbook_dir }}/../infra-ca.crt"
        mode: "0644"
      become: false

    - name: Show CA certificate import instructions
      ansible.builtin.debug:
        msg: >-
          To trust HTTPS in your browser, import infra-ca.crt into Windows:
          1) SCP from control node: scp vmubuntu-6:/opt/infra-ca/ca.crt infra-ca.crt
          2) Double-click → Install Certificate → Local Machine →
          Trusted Root Certification Authorities → Finish.
          Or PowerShell (Admin): Import-Certificate -FilePath infra-ca.crt -CertStoreLocation Cert:\LocalMachine\Root
